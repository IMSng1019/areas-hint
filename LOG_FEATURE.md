# 异步日志功能说明

## 功能概述

该功能为Areas Hint模组添加了完整的异步日志系统，用于记录玩家进入和离开域名的活动。

## 功能特性

### 1. 日志文件管理
- **服务端日志**: 存储在 `.minecraft/areas-hint/server_log/` 文件夹
- **客户端日志**: 存储在 `.minecraft/areas-hint/client_log/` 文件夹
- **自动创建**: 启动时自动检测并创建日志文件夹

### 2. 文件大小限制
- 单个日志文件最大 **10MB**
- 超过限制自动分割为新文件
- 文件命名格式: `YYYYMMDD_序号.log`
  - 例如: `20260204_1.log`, `20260204_2.log`

### 3. 日志保留策略
- **客户端**: 自动清理 **3天前** 的日志
- **服务端**: 自动清理 **7天前** 的日志
- 每次启动时自动执行清理

### 4. 日志内容格式

#### 服务端控制台和日志文件
```
[DD HH:mm:ss] [维度域名][玩家名]进入了[域名等级] [联合域名]的[域名名称]
[DD HH:mm:ss] [维度域名][玩家名]离开了[域名等级] [联合域名]的[域名名称]
```

示例:
```
[04 15:30:45] [蛮荒大陆][Steve]进入了[顶级域名] [主城]
[04 15:35:20] [蛮荒大陆][Steve]离开了[顶级域名] [主城]
[04 15:35:21] [蛮荒大陆][Steve]进入了[二级域名] [商业区]的[市场]
[04 15:40:10] [恶堕之域][Steve]进入了[顶级域名] [地狱要塞]
```

**注意**: 如果联合域名为空，则不显示联合域名部分：
```
[04 15:30:45] [蛮荒大陆][Steve]进入了[顶级域名] [主城]
```

#### 客户端日志文件
```
[DD HH:mm:ss] 玩家进入世界（第N次）
[DD HH:mm:ss] [维度域名]进入了[域名等级] [联合域名]的[域名名称]
[DD HH:mm:ss] [维度域名]离开了[域名等级] [联合域名]的[域名名称]
```

示例:
```
[04 15:30:40] 玩家进入世界（第1次）
[04 15:30:45] [蛮荒大陆]进入了[顶级域名] [主城]
[04 15:35:20] [蛮荒大陆]离开了[顶级域名] [主城]
[04 15:40:10] [恶堕之域]进入了[顶级域名] [地狱要塞]
```

### 5. 网络同步
- 客户端检测到玩家进入/离开域名时，自动发送消息到服务端
- 服务端接收消息后：
  1. 输出到控制台（终端）
  2. 记录到服务端日志文件
- 客户端同时记录到客户端日志文件

### 6. 异步处理
- 所有日志写入操作都在独立线程中异步执行
- 不会影响游戏性能
- 使用单线程执行器保证日志顺序

## 实现细节

### 核心类

1. **AsyncLogManager** (`src/main/java/areahint/log/AsyncLogManager.java`)
   - 异步日志管理器核心类
   - 处理文件创建、写入、分割和清理

2. **ServerLogManager** (`src/main/java/areahint/log/ServerLogManager.java`)
   - 服务端日志管理器
   - 提供服务端日志记录接口

3. **ClientLogManager** (`src/client/java/areahint/log/ClientLogManager.java`)
   - 客户端日志管理器
   - 提供客户端日志记录接口

4. **ServerLogNetworking** (`src/main/java/areahint/log/ServerLogNetworking.java`)
   - 服务端网络处理
   - 接收客户端发送的日志消息

5. **ClientLogNetworking** (`src/client/java/areahint/log/ClientLogNetworking.java`)
   - 客户端网络处理
   - 发送日志消息到服务端

6. **AreaChangeTracker** (`src/client/java/areahint/log/AreaChangeTracker.java`)
   - 区域变化追踪器
   - 检测玩家进入/离开域名并触发日志记录

### 集成点

1. **Areashint.java** (服务端主类)
   - 初始化服务端日志管理器
   - 初始化服务端日志网络处理
   - 服务器停止时关闭日志管理器

2. **AreashintClient.java** (客户端主类)
   - 初始化客户端日志管理器
   - 集成AreaChangeTracker进行区域检测
   - 玩家进入世界时通知日志系统

3. **Packets.java** (网络数据包定义)
   - 添加 `C2S_AREA_LOG` 数据包标识符

## 测试方法

### 1. 启动测试
1. 启动Minecraft客户端
2. 检查 `.minecraft/areas-hint/` 目录
3. 确认 `server_log` 和 `client_log` 文件夹已创建

### 2. 功能测试
1. 进入游戏世界
2. 移动到不同的域名区域
3. 检查服务端控制台输出
4. 检查日志文件内容

### 3. 文件分割测试
1. 生成大量日志（可以通过频繁进出域名）
2. 观察日志文件大小
3. 确认超过10MB时自动创建新文件

### 4. 清理测试
1. 手动创建旧日期的日志文件
2. 重启游戏
3. 确认旧日志被自动清理

## 注意事项

1. 日志系统在模组初始化时自动启动
2. 所有日志操作都是异步的，不会阻塞游戏
3. 日志文件使用UTF-8编码
4. 时间格式：
   - 文件名: `YYYYMMDD` (例如: 20260204)
   - 日志内容: `DD HH:mm:ss` (例如: 04 15:30:45)
5. 如果联合域名为空，日志中不显示联合域名部分
6. 维度域名显示：
   - 默认维度域名：
     - `minecraft:overworld` → "蛮荒大陆"
     - `minecraft:the_nether` → "恶堕之域"
     - `minecraft:the_end` → "终末之地"
   - 可通过服务端配置自定义维度域名

## 性能影响

- **内存**: 每个日志管理器使用一个单线程执行器，内存占用极小
- **CPU**: 异步写入，对游戏性能影响可忽略不计
- **磁盘**: 日志文件自动清理，不会无限增长
